# ai2fa v0.2.0 Migration Notes

Release date: 2026-02-28

This guide covers how to upgrade from `v0.1.x` to `v0.2.0` safely.

## What Changed

### 1. Security profiles expanded to 5 tiers

New levels:
- `minimal`
- `low` (default)
- `medium`
- `high`
- `extra_high`

Legacy names still work and map automatically:
- `relaxed` -> `minimal`
- `balanced` -> `low`
- `strict` -> `medium`
- `paranoid` -> `extra_high`

Note:
- `paranoid` now maps to `extra_high` intentionally to preserve hard-fail behavior.

### 2. Optional authenticator app support (TOTP)

New capability:
- `totp_mode: off|fallback|required`
- `totp_window` for time drift tolerance

New commands:
- `ai2fa totp setup`
- `ai2fa totp verify <6-digit-code>`
- `ai2fa totp status`
- `ai2fa totp disable`

Replay protection is enforced using `totp_last_counter`.

### 3. Challenge phrase storage hardened

Challenge phrase storage moved from plaintext secret to salted hash:
- `challenge_phrase_hash`
- `challenge_phrase_salt`

Legacy plaintext phrases are auto-migrated after the first successful phrase verification.

### 4. Channel transport defaults hardened

Channel requests now use bounded defaults:
- `http_connect_timeout: 5`
- `http_max_time: 15`
- `http_retries: 2`

### 5. Verification behavior updates

`ai2fa verify` can now route through TOTP based on `totp_mode`.

TOTP-specific failures include:
- `FAILED:NO_TOTP_CONFIGURED`
- `FAILED:INVALID_TOTP_FORMAT`
- `FAILED:WRONG_TOTP`
- `FAILED:REPLAY`
- `FAILED:TOTP_SECRET_INVALID`
- `FAILED:TOTP_UNAVAILABLE`

## Upgrade Checklist

1. Update local checkout:

```bash
git pull
```

2. Run regression suite:

```bash
bash scripts/selftest.sh
```

3. Review your config:
- Existing `security_level` values continue working.
- If desired, switch to explicit new names for clarity.
- Add TOTP settings only if you plan to use authenticator mode.

4. If using TOTP:

```bash
ai2fa totp setup
ai2fa status
```

5. Validate full flow:

```bash
ai2fa test
```

## Suggested Config (v0.2.0)

```yaml
channel: telegram
storage: keychain
security_level: low
totp_mode: off
totp_window: 1
```

